<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Label Stats</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    
    <style>
        
        body {
            padding-top: 20px;
            padding-bottom: 60px;
        }
        
        h2.text-center small {  
            display: block;
            margin-top: 12px;
        }
    
    </style>
</head>
<body>
    
    <div class="container">
        
        <div class="row">
            
            <div class="col-md-12">
                <h2 class="text-center"><span id="path"></span> <br> <small>total images: <span id="total_images">300000</span></small></h2>
                <br>
                <table class="table">

                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Label</th>
                            <th>Occurence (%)</th>
                            <th>Avg. Score</th>
                            <th>Q1. Score</th>
                            <th>Q2. Score</th>
                            <th>Q3. Score</th>
                            <th>Min. Score</th>
                            <th>Max. Score</th>
                        </tr>
                    </thead>

                    <tbody id="table_body">
                        
                    </tbody>

                </table>
            </div>
        </div>
        
    </div>
    
    <script src="assets/js/jquery-1.12.4.min.js"></script>
    <script>
        
        var data = { dir_path: "", images: [], total_images: 0, num_violating_images: 0 };
        var label_objs = [];
        var images = data.images;
        
        function get_median(scores) {

            if(scores.length % 2 == 1) {
                return scores[Math.ceil(scores.length / 2) - 1];
            } else {
                half_idx = (scores.length / 2) - 1;
                return (scores[half_idx] + scores[half_idx + 1]) / 2;
            }
        }

        function get_q1(scores) {

            end_idx = Math.floor(scores.length / 2) - 1;
            sub_scores = scores.slice(0, end_idx + 1);

            return get_median(sub_scores);
        }

        function get_q3(scores) {

            start_idx = Math.ceil(scores.length / 2);
            sub_scores = scores.slice(start_idx, scores.length);

            return get_median(sub_scores);
        }
        
        for(var i = 0; i < images.length; i++) {
            
            var label_obj = {};
            
            var aws_labels = JSON.parse(images[i].rekognition_result);
            var google_labels = JSON.parse(images[i].google_labels);
            
            for(var j = 0; j < aws_labels.length; j++) {
                
                var label = aws_labels[j]['Name'].toLowerCase();
                var score = aws_labels[j]['Confidence'];
                
                label_obj[label] = score;
            }
            
            for(var j = 0; j < google_labels.length; j++) {
                
                var label = google_labels[j]['description'].toLowerCase();
                var score = google_labels[j]['score'] * 100;
                
                if(label_obj[label]) {
                    label_obj[label] = Math.max(label_obj[label], score);
                } else {
                    label_obj[label] = score;
                }
                
            }
            
            label_objs.push(label_obj);
        }
        
        var stats_data = {};
        for(var i = 0; i < label_objs.length; i++) {
            
            var label_obj = label_objs[i];
            
            for(key in label_obj) {
                
                var score = label_obj[key];
                if(key in stats_data) {
                    
                    var row = stats_data[key];
                    row['scores'].push(score);
                } 
                else
                    stats_data[key] = {name: key, scores: [score]};
            }
        }
        
        $('#path').text(data.dir_path);
        $('#total_images').text(data.total_images);
        
        stats_arr = [];
        for(key in stats_data)
            stats_arr.push(stats_data[key]);
        
        stats_arr.sort((a, b) => { return b.scores.length - a.scores.length; });
        
        var table_body = $('#table_body');
        var total_data = images.length;
        var num_decimal_digits = 4;
        
        for(var i = 0; i < stats_arr.length; i++) {
            
            var row = stats_arr[i];
            
            var name = row['name'];
            var scores = row['scores'];
            
            scores.sort((a, b) => { return a - b; });
            
            var percentage_occurrence = (scores.length * 100 / total_data).toFixed(2);
            var average_score = (scores.reduce((acc, val) => { return acc + val; }) / scores.length).toFixed(num_decimal_digits);
            
            var min_score = scores[0].toFixed(num_decimal_digits);
            var max_score = scores[scores.length - 1].toFixed(num_decimal_digits);
            
            var med_score = get_median(scores).toFixed(num_decimal_digits);
            var q1_score = get_q1(scores).toFixed(num_decimal_digits);
            var q3_score = get_q3(scores).toFixed(num_decimal_digits);
            
            table_body.append('<tr> <td>' + (i + 1) + '.</td> <td>' + name + '</td> <td>' + percentage_occurrence + '%</td> <td>' + average_score + '</td> <td>' + q1_score + '</td> <td>' + med_score + '</td> <td>' + q3_score + '</td> <td>' + min_score + '</td> <td>' + max_score + '</td> </tr>');
        }
        
    </script>
</body>
</html>